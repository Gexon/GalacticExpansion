# System Patterns — GalacticExpansion (GLEX)

## Архитектурные паттерны

### Модульный монолит
- Единая DLL с четкими границами модулей.
- Расширяемость через интерфейсы и события.

### Event-Driven Architecture
- Взаимодействие через `EventBus`.
- Минимизация прямых зависимостей между модулями.

### Repository Pattern
- `IStateStore` управляет загрузкой/сохранением state.json.
- Атомарная запись и бэкапы — обязательны.

### Command Pattern
- AIM-команды оборачиваются в команды и валидируются.

## Ключевые технические решения

### Wrapper Pattern (изоляция Unity)
- `IPlayfieldWrapper` изолирует Unity-зависимости `IPlayfield`.
- Моки `IPlayfieldWrapper` работают в unit-тестах.

### State Sync Pattern
- Изменения колонии в критичных методах делаются через объект из `StateStore.LoadAsync`.
- После обновления — обязательное `SaveAsync`.

### Interface Contract Alignment
- Реализации обязаны повторять порядок параметров и смысл контрактов интерфейсов.
- Тесты проверяют соответствие контрактам.

## Важные инварианты

1. `State.json` всегда валиден (атомарная запись + бэкапы).
2. `SeqNr` уникальны и корректно сопоставляются.
3. Rate limiting обязателен для ModAPI запросов.
4. Спавн структур и NPC идет через `IEntitySpawner`.
5. Переходы стадий всегда сопровождаются синхронизацией state.
