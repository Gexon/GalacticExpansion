“Галактическая экспансия”. 
Ниже — комплект документации (как файлы/шаблоны), ориентированный на server-side DLL под Empyrion 1.15 Experimental, ванильный Default Multiplayer, Zirax-экспансию, динамический спавн структур/юнитов и “логистику” через видимые AI-корабли + staged-эволюцию баз.

01_Техническое задание.md — очень подробное ТЗ (SRS)

02_Архитектурный план.md — архитектурный план (C4: Context/Container/Component)

03_Технический проект.md — технический проект (детализация модулей/классов/алгоритмов)

04_Modular_Development_Plan - План модульной разработки. Настоящий документ описывает стратегию модульной разработки проекта. Система декомпозирована на функциональные модули, соответствующие основным бизнес-возможностям, описанным в ТЗ. Этот подход ("модульный монолит") позволяет:
Снизить когнитивную нагрузку: Команды могут фокусироваться на конкретной бизнес-области.
Упростить разработку: Четкие границы между модулями минимизируют непреднамеренные зависимости.
Обеспечить гибкость: В будущем любой модуль может быть относительно легко выделен в отдельный микросервис.

05_Схема данных.md — схема данных симуляции (JSON/SQLite)

ConfigReference.md — конфиг мода (лимиты, вероятности, расписания, профили планет)

Operations_Runbook.md — эксплуатация на dedicated (логи, команды, миграции, бэкапы)

09_Testing_Strategy.md — Стратегия тестирования проекта (нагрузка, воспроизводимость, анти-дюп). Этот документ описывает принятую в проекте стратегию тестирования, её цели, используемые инструменты и ключевые правила. Цель этого документа — обеспечить единый подход к написанию тестов, повысить их качество, надежность и поддерживаемость, а также служить руководством для всех разработчиков и AI-ассистентов.

Security_AbuseCases.md — защита от злоупотреблений (особенно если используются Request_ConsoleCommand/AIM).

Могут быть еще документы, по необходимости.

# Техническое задание для проекта GalacticExpansion (GLEX)

**GalacticExpansion (GLEX)** — server-side DLL мод для Empyrion: Galactic Survival (v1.15 Experimental) для имитации «живой» захваченной планеты и дальнейшей экспансии Zirax.

## 1. Термины

- **Playfield**: отдельный игровой “инстанс” (планета, орбита планеты, солнечная орбита и т.д.).
- **Entity**: любая сущность с entityId (структура, корабль, NPC и т.п.) управляемая через API.
- **Stage**: стадия развития объекта/колонии (Landing → Yard → Base L1 → Base L2 → … → Max).
- **Colony**: логическая сущность, содержащая: базу, ресурсные точки, охрану, логистику, портал и т.п.
- **SV**: small vessel, **CV**: capital vessel, **BA**: base, **HV**: hover vessel

## 2. Область применения

Мод работает на dedicated server и не требует client-side модов/скриптов.
Мод предназначен для ванильного сценария Default Multiplayer.

## 3. Функциональные требования

### FR-001 Инициализация мира

- При первом запуске мода:
    - создаётся файл состояния `state.json` (если отсутствует);
    - в нём фиксируется “материнская” планета (конфигом: `HomePlayfield` строкой имени);
    - создаётся `Colony` со стадией `LandingPending`.
    - активируется жизненный цикл, который симулирует экспансию, симулирует строительство, добычу ресурсов.

### FR-002 Обнаружение игрока на планете

- Мод должен отслеживать вход игроков на playfield:
    - по событию `Event_Player_ChangedPlayfield` отображать юниты, коробли и постройки согласно симуляции.

### FR-003 Лимиты и квоты (настраиваемые)

Конфигом задаются лимиты:

- `MaxColoniesPerPlayfield` (для MVP = 1),
- `MaxActiveAIVessels` (на планету),
- `MaxGuardsNearColony`,
- `MaxBuildersNearColony`,
- `MaxResourceOutposts`,
- `MaxDroneWavesPerHour`,
- `MaxAIMCommandsPerMinute` (защита от спама консольных команд).


### FR-004 “Посадка SV → исчезновение → стройплощадка”

Сценарий строительства:

1) **Spawn логистического SV/CV в атмосфере**

- Мод спавнит “логистический” корабль (SV или CV) через `Request_Entity_Spawn` с `EntitySpawnInfo`:
    - `type` = SV или CV,
    - `prefabName` = конфигом (например `GLEX_DropShip_T1`),
    - `factionGroup`/`factionId` — Zirax (конкретный id берётся из конфигурации/настройки).
- Спавн происходит на высоте `DropShipSpawnAltitude` над ориентировочной точкой посадки.

2) **Имитация посадки**
Так как API не гарантирует определение поверхности, мод использует режимы:

- `FlightMode=RealAI`: даёт кораблю время “полетать” в зоне (N секунд), после чего он исчезает (destroy) и считается доставившим груз.
- `FlightMode=CinematicFallback`: корабль появляется, делает круг/зависает (таймер), исчезает.
Оба режима не требуют задания маршрута (такого API нет).

3) **Создание стройплощадки**
После “доставки”:

- спавнится `ConstructionYard` (BA префаб) на выбранной точке через `Request_Entity_Spawn`.
- рядом спавнится “склад ресурсов” (малый BA-префаб) или это часть того же префаба.

4) **Спавн охраны и строителей**
Варианты реализации:

- через NPC спавнеры внутри стройплощадки (не предпочтительно: меньше контроля);
- или через `Request_Entity_Spawn` c `entityTypeName` (если серверная версия это стабильно поддерживает) для `ZiraxMale`/строителей и т.п.
Фракционность NPC при спавне через спавнеры наследуется от базы по настройкам “FACTION default same as base”, что важно для Zirax-колонии.

### FR-005 Стадийное улучшение базы

- База имеет стадии `Base_L1`, `Base_L2`, … `Base_Max`.
- Переход стадии происходит при накоплении “виртуальных ресурсов” и прохождении времени:
    - `resources += productionRate * dt`.
- Переход стадии реализуется:
    - вариант A (надёжный): destroy старой структуры + spawn новой (новый prefabName);
    - вариант B (если решишь задействовать миссионные механики позже): заменить структуру “runtime replace”, но в этом проекте — строго DLL, значит A — базовый.

### FR-006 Патрули/перехват высадки игроков

При присутствии игрока на планете:

- мод обязан создать угрозу рядом с точками интереса:
    - патрульные дроны/охрана “у базы”,
    - волны атак на базу игрока (если она построена).
Для этого используется AIM:
- `aim aga ...` — охрана области (вокруг игрока/структуры)
- `aim tdw <PlBaseId>` — волна на базу игрока
- `aim adb ...` — спавн дронбазы, если нужно “усиление обороны”.
AIM вызывается модом через `Request_ConsoleCommand`.

### FR-007 “Ресурсные точки” и добыча

Требование “НПС находят точки ресурсов и ставят добывающие здания” реализуется как симуляция:

- Мод выбирает точку `ResourceNode` (координаты) по правилам:
    - на расстоянии от базы и от построек игроков;
    - вне запретного радиуса spawn-protection;
    - ограничение по количеству `MaxResourceOutposts`.
- Далее мод спавнит добывающее здание (BA prefab “GLEX_MinerOutpost_L1”) и увеличивает добычу ресурсов в state.
Точные “депозиты руды” в ванили модом надёжно не считываются, поэтому `ResourceNode` — это не “реальная руда”, а геймплейная имитация.

### FR-008 Экспансия на новые планеты

- Когда колония достигает `Base_Max`, начинается “expansion cycle”:
    - создаётся логистический корабль, “улетает” (визуально) и после задержки создаётся `LandingPending` на новой планете.
- В MVP экспансия включается флагом, но может быть выключена.
Важно: т.к. “маршрута” нет, перелёт — через таймер и появление на целевом playfield после условия “есть игроки/плейфилд загружен” или через принудительную загрузку playfield.

### FR-009 Портал, верфь, корабль-база

Контентные сущности (по лору) реализуются как отдельные стадии/структуры:

- `PortalSite_L1..Lx` (BA префабы + энергопотребление как лор),
- `AlienShipyard` (BA/CV POI),
- `ShipBase_Landing`: CV, который после посадки “превращается” в BA (destroy CV + spawn BA).
Это не требует “нового AI”, только staged spawn/destroy.

### FR-010 Метеоритный дождь, разрушающий POI

- Мод должен иметь событие “MeteorStorm”:
    - выбирает одну из Zirax структур и наносит “событийный урон”:
        - вариант A: частичное разрушение (если нет API для урона блоку — заменить на “damaged prefab”),
        - вариант B: полностью destroy и откат стадии.
Так как ModAPI ориентирован на entity-уровень, реализация урона по блокам может быть ограничена; базовая реализация — через замену prefabs.

### FR-011 Реакция на действия игроков (PVE/PVP)

- Игроки могут разрушать структуры, убивать NPC/дронов/корабли.
- Мод должен:
    - детектировать разрушение ключевых сущностей (через `Event_Statistics` и/или сверку списков `Request_GlobalStructure_List`).
    - обновлять state: “структура уничтожена → стадия откат → план реконструкции”.
    - при необходимости — усиливать охрану и вызывать AIM-волны.

## 4. Нефункциональные требования

- Производительность: мод не должен спамить запросами API; используется очередь запросов и rate limit.
- Надёжность: state.json пишется атомарно (write temp → rename).
- Совместимость: только v1.15 Experimental; при смене версии — мягкий fail + лог.
- Безопасность: белый список разрешённых консольных команд (только `aim ...`, `say ...` опционально).

# Архитектурный план мода GalacticExpansion (GLEX).

 **GalacticExpansion (GLEX)** — server-side DLL мод для Empyrion: Galactic Survival (v1.15 Experimental) для имитации «живой» захваченной планеты и дальнейшей экспансии Zirax.

## Контекст (Context)

- Empyrion Dedicated Server
    - Загружает Mod DLL через ModInterface.
- GLEX Mod DLL
    - Получает события через `Game_Event`
    - Отправляет запросы через `Game_Request`.

## Контейнеры (Containers)

1) **Core Loop (SimulationEngine)**

- таймер/тик;
- обновление state;
- планирование действий.

2) **EmpyrionGateway**

- адаптер для `Game_Request`/`Game_Event` и SeqNr.
- очереди запросов, retry, дедупликация.

3) **WorldModel (StateStore)**

- загрузка/сохранение JSON.
- миграции версии схемы.

4) **Spawning \& Evolution**

- EntitySpawner: `Request_NewEntityId` → `Request_Entity_Spawn`.
- EntityDestroyer: destroy через `Request_Entity_Destroy*`.
- StageManager: конечные автоматы стадий.

5) **AIM Orchestrator**

- безопасная отправка `aim ...` через `Request_ConsoleCommand`.

6) **Placement \& Surface Resolver**

- модуль выбора координат.
- модуль “вычисления поверхности” (эвристики): см. `DetailedDesign.md`.

## Компоненты (Components)

- `PlayerTracker`: подписка на `Event_Player_ChangedPlayfield`, получение `PlayerInfo` при необходимости.
- `StructureTracker`: периодический `Request_GlobalStructure_List` и индексация.
- `ThreatDirector`: решает когда создавать патрули/волны.
- `EconomySim`: виртуальные ресурсы/производство/логистика.
- `ExpansionPlanner`: выбор следующей планеты для захвата.