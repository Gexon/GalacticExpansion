# Технический проект (GLEX)

**Назначение**: детализация ключевых модулей/алгоритмов и “контрактов” между ними.  
**Аудитория**: разработчики.  
**Статус**: draft.  
**Связанные документы**: [`00_Modular_Development_Plan.md`](00_Modular_Development_Plan.md), [`04_data_model.md`](04_data_model.md), [`05_placement_and_spawn.md`](05_placement_and_spawn.md).  

## 1) Главный цикл симуляции (SimulationEngine)

### Ответственность

- держать единый тик/таймер;
- решать, какие действия выполнять сейчас (build/upgrade/spawn/attack);
- не допускать “взрывного” количества запросов к серверу.

### Входные данные

- события (в первую очередь: смена playfield игроком, статистика разрушений);
- текущее `state.json`;
- конфиг лимитов/интервалов.

### Выходные действия

- запланированные requests на спавн/удаление/телепорт;
- команды AIM через `AimOrchestrator`.

## 2) Шлюз ModAPI (EmpyrionGateway)

### Почему нужен

`Game_Event` передаёт `object data`, и тип корректен только при правильной обработке `CmdId`.  
Шлюз нужен, чтобы:

- централизовать касты/валидации;
- обеспечить сопоставление “request → response” по `seqNr`;
- применять rate limit и дедупликацию.

### Базовый паттерн `seqNr`

Шлюз должен:

- выдавать уникальные `seqNr` для каждого request (в рамках процесса);
- хранить таблицу ожидания ответов;
- по приходу события-ответа с `seqNr` — завершать ожидание и отдавать результат.

## 3) Стадийность (StageManager)

### Принцип (надёжный путь)

Переход стадии структуры делается через:

- `destroy old entity` → `spawn new entity` (с новым `prefabName`)

Это соответствует черновику требований (вариант A).

### Реакция на разрушение

Если уничтожена “ключевая сущность” стадии:

- фиксируем событие в state;
- откатываем Stage (или ставим `RebuildPending`);
- планируем реконструкцию по правилам и лимитам.

## 4) AIM (AimOrchestrator)

### Ключевые требования безопасности

- разрешены только команды из whitelist (например, `aim ...` из ограниченного набора);
- стоит лимит `MaxAIMCommandsPerMinute`;
- любое отклонение логируется (что пытались отправить и почему запрещено).

## 5) “Логистика: корабль → стройплощадка” (FR-004)

Сценарий:

1) spawn логистического SV/CV на высоте `DropShipSpawnAltitude`;
2) выдержать “полет/зависание” N секунд (режим `RealAI` или `CinematicFallback`);
3) destroy корабля и считать “доставка завершена”;
4) spawn `ConstructionYard` (BA prefab) и сопутствующие элементы;
5) спавн охраны/строителей (если доступно) или через встроенные спавнеры prefab’ов.

## 6) Ограничения производительности (обязательные)

- все периодические опросы (`Request_GlobalStructure_List` и т.п.) выполняются не чаще заданного интервала;
- любые bursts (массовый spawn/destroy) раскладываются на несколько тиков.