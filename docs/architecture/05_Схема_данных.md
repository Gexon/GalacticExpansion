# Схема данных GalacticExpansion (GLEX)

**Версия:** 1.0  
**Дата:** 24.01.2026  
**Статус:** Утверждено

---

## 1. Обзор хранения данных

### 1.1 Типы хранимых данных

**State Data (state.json):**
- Динамическое состояние симуляции
- Колонии и их параметры
- Playfield states
- Временные данные (cooldowns, timers)

**Configuration Data (Configuration.json):**
- Статическая конфигурация мода
- Лимиты и параметры баланса
- Prefab mappings

**Logs:**
- Структурированные логи событий
- Отладочная информация
- Audit trail для AIM-команд

---

## 2. Схема state.json

### 2.1 Полная схема (версия 1)

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "GalacticExpansion Simulation State",
  "type": "object",
  "properties": {
    "Version": {
      "type": "integer",
      "description": "Версия схемы данных",
      "minimum": 1
    },
    "CreatedAt": {
      "type": "string",
      "format": "date-time",
      "description": "Время создания симуляции"
    },
    "LastUpdate": {
      "type": "string",
      "format": "date-time",
      "description": "Время последнего обновления"
    },
    "LastSaveTime": {
      "type": "string",
      "format": "date-time",
      "description": "Время последнего сохранения"
    },
    "Colonies": {
      "type": "array",
      "items": { "$ref": "#/definitions/Colony" }
    },
    "Playfields": {
      "type": "object",
      "additionalProperties": { "$ref": "#/definitions/PlayfieldState" }
    }
  },
  "required": ["Version", "CreatedAt", "LastUpdate", "Colonies", "Playfields"],
  
  "definitions": {
    "Colony": {
      "type": "object",
      "properties": {
        "Id": { "type": "string" },
        "Playfield": { "type": "string" },
        "FactionId": { "type": "integer" },
        "Stage": { "$ref": "#/definitions/ColonyStage" },
        "Position": { "$ref": "#/definitions/Vector3" },
        "Rotation": { "$ref": "#/definitions/Vector3" },
        "MainStructureId": { "type": "integer", "description": "Entity ID главной структуры" },
        "Resources": { "$ref": "#/definitions/Resources" },
        "UnitPool": { "$ref": "#/definitions/UnitPool" },
        "ResourceNodes": {
          "type": "array",
          "items": { "$ref": "#/definitions/ResourceNode" }
        },
        "Guards": {
          "type": "array",
          "items": { "$ref": "#/definitions/GuardUnit" }
        },
        "ThreatLevel": { "type": "integer", "minimum": 0, "maximum": 5 },
        "LastUpgradeTime": { "type": "string", "format": "date-time" },
        "LastAttackTime": { "type": "string", "format": "date-time" },
        "DestructionEvents": {
          "type": "array",
          "items": { "$ref": "#/definitions/DestructionEvent" }
        },
        "CreatedAt": { "type": "string", "format": "date-time" }
      },
      "required": ["Id", "Playfield", "FactionId", "Stage", "Position"]
    },
    
    "ColonyStage": {
      "type": "string",
      "enum": ["LandingPending", "ConstructionYard", "BaseL1", "BaseL2", "BaseL3", "BaseMax", "ExpansionCycle"]
    },
    
    "Vector3": {
      "type": "object",
      "properties": {
        "X": { "type": "number" },
        "Y": { "type": "number" },
        "Z": { "type": "number" }
      },
      "required": ["X", "Y", "Z"]
    },
    
    "Resources": {
      "type": "object",
      "properties": {
        "VirtualResources": { "type": "number", "minimum": 0 },
        "ProductionRate": { "type": "number", "minimum": 0 }
      }
    },
    
    "ResourceNode": {
      "type": "object",
      "properties": {
        "Id": { "type": "string" },
        "Type": { "type": "string", "enum": ["Iron", "Copper", "Silicon", "Promethium", "Mixed"] },
        "Position": { "$ref": "#/definitions/Vector3" },
        "StructureId": { "type": "integer" },
        "ProductionRate": { "type": "number" },
        "CreatedAt": { "type": "string", "format": "date-time" }
      }
    },
    
    "GuardUnit": {
      "type": "object",
      "properties": {
        "EntityId": { "type": "integer" },
        "Type": { "type": "string" },
        "SpawnedAt": { "type": "string", "format": "date-time" }
      }
    },
    
    "UnitPool": {
      "type": "object",
      "properties": {
        "AvailableGuards": { "type": "integer", "minimum": 0, "description": "Доступные охранники для спавна" },
        "MaxGuards": { "type": "integer", "minimum": 0, "description": "Максимальная вместимость гарнизона" },
        "AvailablePatrolVessels": { "type": "integer", "minimum": 0, "description": "Доступные патрульные корабли" },
        "MaxPatrolVessels": { "type": "integer", "minimum": 0 },
        "AvailableWarships": { "type": "integer", "minimum": 0, "description": "Доступные боевые корабли" },
        "MaxWarships": { "type": "integer", "minimum": 0 },
        "AvailableDrones": { "type": "integer", "minimum": 0, "description": "Доступные дроны для волн" },
        "MaxDrones": { "type": "integer", "minimum": 0 },
        "ProductionRate": { "type": "number", "minimum": 0, "description": "Скорость производства юнитов (в час)" },
        "LastProductionTime": { "type": "string", "format": "date-time", "description": "Последнее время производства" },
        "ProductionProgress": { "type": "number", "minimum": 0, "description": "Накопленный прогресс производства (дробная часть)" },
        "ActiveUnits": {
          "type": "array",
          "items": { "$ref": "#/definitions/ActiveUnit" }
        }
      }
    },
    
    "ActiveUnit": {
      "type": "object",
      "properties": {
        "EntityId": { "type": "integer", "description": "Entity ID в игре" },
        "Type": { "type": "string", "enum": ["Guard", "PatrolVessel", "Warship", "Drone", "EliteHunter"], "description": "Тип юнита" },
        "SpawnedAt": { "type": "string", "format": "date-time", "description": "Время спавна" },
        "AssignedRole": { "type": "string", "description": "Назначенная роль (Guard, Patrol, Hunter, Wave)" }
      }
    },
    
    "DestructionEvent": {
      "type": "object",
      "properties": {
        "Timestamp": { "type": "string", "format": "date-time" },
        "DestroyedEntityId": { "type": "integer" },
        "DestroyedType": { "type": "string" },
        "DestroyedBy": { "type": "integer", "description": "Player ID или Entity ID" }
      }
    },
    
    "PlayfieldState": {
      "type": "object",
      "properties": {
        "Name": { "type": "string" },
        "HasPlayers": { "type": "boolean" },
        "LastPlayerActivity": { "type": "string", "format": "date-time" },
        "ColonyIds": {
          "type": "array",
          "items": { "type": "string" }
        },
        "LastStructureRefresh": { "type": "string", "format": "date-time" }
      }
    }
  }
}
```

### 2.2 Пример state.json

```json
{
  "Version": 1,
  "CreatedAt": "2026-01-24T10:00:00Z",
  "LastUpdate": "2026-01-24T15:30:45Z",
  "LastSaveTime": "2026-01-24T15:30:00Z",
  "Colonies": [
    {
      "Id": "col_akua_001",
      "Playfield": "Akua",
      "FactionId": 2,
      "Stage": "BaseL2",
      "Position": {
        "X": 1234.5,
        "Y": 150.0,
        "Z": -987.3
      },
      "Rotation": {
        "X": 0,
        "Y": 45,
        "Z": 0
      },
      "MainStructureId": 50001,
      "Resources": {
        "VirtualResources": 5432.7,
        "ProductionRate": 150.0
      },
      "UnitPool": {
        "AvailableGuards": 4,
        "MaxGuards": 10,
        "AvailablePatrolVessels": 1,
        "MaxPatrolVessels": 2,
        "AvailableWarships": 0,
        "MaxWarships": 1,
        "AvailableDrones": 15,
        "MaxDrones": 20,
        "ProductionRate": 4.5,
        "LastProductionTime": "2026-01-29T14:30:00Z",
        "ProductionProgress": 0.3,
        "ActiveUnits": [
          {
            "EntityId": 50020,
            "Type": "Guard",
            "SpawnedAt": "2026-01-29T14:00:00Z",
            "AssignedRole": "BaseDefense"
          },
          {
            "EntityId": 50021,
            "Type": "Guard",
            "SpawnedAt": "2026-01-29T14:05:00Z",
            "AssignedRole": "Patrol"
          },
          {
            "EntityId": 50030,
            "Type": "PatrolVessel",
            "SpawnedAt": "2026-01-29T13:00:00Z",
            "AssignedRole": "AreaPatrol"
          }
        ]
      },
      "ResourceNodes": [
        {
          "Id": "rn_001",
          "Type": "Iron",
          "Position": { "X": 1500, "Y": 145, "Z": -1200 },
          "StructureId": 50010,
          "ProductionRate": 75.0,
          "CreatedAt": "2026-01-24T11:00:00Z"
        },
        {
          "Id": "rn_002",
          "Type": "Copper",
          "Position": { "X": 1000, "Y": 140, "Z": -800 },
          "StructureId": 50011,
          "ProductionRate": 50.0,
          "CreatedAt": "2026-01-24T12:30:00Z"
        }
      ],
      "Guards": [
        {
          "EntityId": 50020,
          "Type": "ZiraxMale",
          "SpawnedAt": "2026-01-24T10:30:00Z"
        },
        {
          "EntityId": 50021,
          "Type": "ZiraxMale",
          "SpawnedAt": "2026-01-24T10:30:05Z"
        }
      ],
      "ThreatLevel": 2,
      "LastUpgradeTime": "2026-01-24T13:00:00Z",
      "LastAttackTime": "2026-01-24T14:45:00Z",
      "DestructionEvents": [
        {
          "Timestamp": "2026-01-24T14:00:00Z",
          "DestroyedEntityId": 50005,
          "DestroyedType": "ResourceNode",
          "DestroyedBy": 100
        }
      ],
      "CreatedAt": "2026-01-24T10:00:00Z"
    }
  ],
  "Playfields": {
    "Akua": {
      "Name": "Akua",
      "HasPlayers": true,
      "LastPlayerActivity": "2026-01-24T15:29:00Z",
      "ColonyIds": ["col_akua_001"],
      "LastStructureRefresh": "2026-01-24T15:30:00Z"
    },
    "Omicron": {
      "Name": "Omicron",
      "HasPlayers": false,
      "LastPlayerActivity": "2026-01-23T20:15:00Z",
      "ColonyIds": [],
      "LastStructureRefresh": "2026-01-24T15:00:00Z"
    }
  }
}
```

---

## 3. Схема Configuration.json

### 3.1 Полная структура конфигурации

```json
{
  "Version": "1.0",
  "LogLevel": "Information",
  
  "Simulation": {
    "TickIntervalMs": 1000,
    "SaveIntervalMinutes": 1,
    "StateBackupIntervalHours": 24,
    "KeepBackupCount": 10
  },
  
  "HomePlayfield": "Akua",
  "EnableExpansion": false,
  
  "Limits": {
    "MaxColoniesPerPlayfield": 1,
    "MaxActiveAIVessels": 5,
    "MaxGuardsNearColony": 10,
    "MaxBuildersNearColony": 5,
    "MaxResourceOutposts": 3,
    "MaxDroneWavesPerHour": 4,
    "MaxAIMCommandsPerMinute": 10,
    "MaxRequestsPerSecond": 10
  },
  
  "Zirax": {
    "FactionId": 2,
    
    "DropShips": [
      {
        "PrefabName": "GLEX_DropShip_T1",
        "Type": "SV",
        "SpawnAltitude": 500.0,
        "FlightDurationSeconds": 30
      }
    ],
    
    "Stages": [
      {
        "Stage": "ConstructionYard",
        "PrefabName": "GLEX_ConstructionYard",
        "RequiredResources": 0,
        "ProductionRate": 100.0,
        "MinTimeSeconds": 600
      },
      {
        "Stage": "BaseL1",
        "PrefabName": "GLEX_Base_L1",
        "RequiredResources": 1000,
        "ProductionRate": 150.0,
        "MinTimeSeconds": 1800
      },
      {
        "Stage": "BaseL2",
        "PrefabName": "GLEX_Base_L2",
        "RequiredResources": 3000,
        "ProductionRate": 200.0,
        "MinTimeSeconds": 3600
      },
      {
        "Stage": "BaseL3",
        "PrefabName": "GLEX_Base_L3",
        "RequiredResources": 6000,
        "ProductionRate": 250.0,
        "MinTimeSeconds": 7200
      },
      {
        "Stage": "BaseMax",
        "PrefabName": "GLEX_Base_Max",
        "RequiredResources": 10000,
        "ProductionRate": 300.0,
        "MinTimeSeconds": 14400
      }
    ],
    
    "ResourceOutposts": [
      {
        "Type": "Iron",
        "PrefabName": "GLEX_Miner_Iron",
        "ProductionRate": 75.0
      },
      {
        "Type": "Copper",
        "PrefabName": "GLEX_Miner_Copper",
        "ProductionRate": 50.0
      }
    ],
    
    "Guards": [
      {
        "Type": "ZiraxMale",
        "Count": 5
      }
    ]
  },
  
  "AIM": {
    "AllowedCommands": ["aim aga", "aim tdw", "aim adb"],
    "RateLimitPerMinute": 10,
    "DefaultGuardRange": 500,
    "DroneWaveCooldownMinutes": 15
  },
  
  "Placement": {
    "MinDistanceFromPlayers": 500.0,
    "MinDistanceFromPlayerStructures": 1000.0,
    "SearchRadius": 2000.0,
    "PreferredAltitude": 150.0,
    "MaxPlacementAttempts": 10
  },
  
  "Threat": {
    "PlayerProximityWeight": 10.0,
    "DestructionWeight": 20.0,
    "AttackDecayMinutes": 60,
    "StageValueWeight": 5.0
  },
  
  "Expansion": {
    "TargetPlayfields": ["Omicron", "Ningues", "Tallodar"],
    "TravelTimeMinutes": 30,
    "MinTimeSinceMaxStageMinutes": 120
  }
}
```

---

## 4. Версионирование и миграции

### 4.1 Стратегия версионирования

**Версия схемы:**
- `Version` field в state.json указывает версию схемы
- Текущая версия: 1
- Инкрементируется при breaking changes

**Правила миграции:**
1. Всегда создавать бэкап перед миграцией
2. Миграции применяются последовательно (1→2→3)
3. Backward compatibility для минорных изменений

### 4.2 Миграции

**Version 1 → Version 2 (пример):**

```csharp
private SimulationState MigrateV1ToV2(SimulationState state)
{
    _logger.LogInformation("Migrating state from v1 to v2");
    
    // Пример: добавление нового поля ThreatLevel
    foreach (var colony in state.Colonies)
    {
        if (colony.ThreatLevel == 0)
        {
            // Расчет начального значения на основе Stage
            colony.ThreatLevel = (int)colony.Stage switch
            {
                ColonyStage.ConstructionYard => 1,
                ColonyStage.BaseL1 => 2,
                ColonyStage.BaseL2 => 3,
                ColonyStage.BaseL3 => 4,
                ColonyStage.BaseMax => 5,
                _ => 1
            };
        }
    }
    
    state.Version = 2;
    return state;
}
```

**Version 2 → Version 3 (будущее):**

```csharp
private SimulationState MigrateV2ToV3(SimulationState state)
{
    // Пример: рефакторинг структуры Resources
    foreach (var colony in state.Colonies)
    {
        // Преобразование старой структуры в новую
        colony.ResourceSystem = new ResourceSystem
        {
            Storage = colony.Resources.VirtualResources,
            ProductionRate = colony.Resources.ProductionRate,
            // Новые поля
            Capacity = 10000,
            ProductionMultiplier = 1.0
        };
    }
    
    state.Version = 3;
    return state;
}
```

---

## 5. Стратегия персистентности

### 5.1 Атомарная запись

**Алгоритм:**
1. Сериализовать state в JSON
2. Записать в временный файл `state.json.tmp`
3. Атомарно переименовать (replace) `state.json.tmp` → `state.json`

**Преимущества:**
- Нет коррупции данных при сбое
- Либо старая версия, либо новая (никогда частично записанная)

### 5.2 Бэкапы

**Автоматические бэкапы:**
- Создаются раз в 24 часа (конфигурируется)
- Хранятся последние 10 (конфигурируется)
- Имя: `state_backup_yyyyMMdd_HHmmss.json`

**Восстановление:**
1. При ошибке чтения state.json
2. Поиск последнего валидного бэкапа
3. Восстановление и продолжение работы

### 5.3 Периодичность сохранения

| Условие | Интервал |
|---------|----------|
| Есть изменения (IsDirty) | 1 минута |
| Нет изменений | Не сохранять |
| Перед остановкой | Немедленно |
| После критичных операций | Немедленно |

---

## 6. Связь с другими документами

- **[01_Техническое_задание.md](01_Техническое_задание.md)** — требования к данным
- **[03_Технический_проект.md](03_Технический_проект.md)** — реализация StateStore
- **[06_ConfigReference.md](06_ConfigReference.md)** — полный справочник конфигурации